trigger:
- master

pool: Default


#Global Variables
variables:
 myResourceGroupName: ShiraStorageAccount-rg
 subscriptionName: "MSEC_Candidates_Homeworks"
 subscriptionID: "a8108c2b-496c-424d-8347-ecc8afb6384c"

#Connect to the self-hosted agents
steps:
- script: hostname

#- task: GitHubComment@0
#  inputs:
#    gitHubConnection: 'github.com_shiraZadok'
#    repositoryName: 'shiraZadok/AzureRmPipeline_MTC'


#Task 2
#Create an ARM template for storage account
#And create 2 storage accounts
#- task: PowerShell@2
#  inputs:
#    targetType: 'inline'
#    script: |
#      New-AzResourceGroupDeployment -Name Deployment_Create_storageaccount_A `
#      -ResourceGroupName $(myResourceGroupName) `
#      -TemplateFile 'ARM_Templete_StorageAccount.json' `
#      -TemplateParameterFile 'parameters_sa1.json'
#
#      New-AzResourceGroupDeployment -Name Deployment_Create_storageaccount_B `
#      -ResourceGroupName $(myResourceGroupName) `
#      -TemplateFile 'ARM_Templete_StorageAccount.json' `
#      -TemplateParameterFile 'parameters_sa2.json'


#Task 3
#Create an ARM template for a Windows server
#- task: PowerShell@2
#  inputs:
#    targetType: 'inline'
#    script: |
      
      #New-AzResourceGroupDeployment `
      #-Name Deployment_create_VM `
      #-ResourceGroupName $(myResourceGroupName) `
      #-TemplateFile 'WindowsServerTemplate.json' `
      #-TemplateParameterFile 'WindowsServerParameters.json'


#Task 3
#Create an ARM template for a Windows server
#- task: PowerShell@2
#  inputs:
#    targetType: 'inline'
#    script: |
#      
#      New-AzResourceGroupDeployment `
#     -Name Deployment_create_VM_2 `
#      -ResourceGroupName '$(myResourceGroupName)' `
#      -TemplateFile 'template.json' `
#      -TemplateParameterFile 'parameters.json'

#- task: AzureMonitorAlerts@0
#  inputs:
#    azureSubscription: $(subscriptionName)
#    ResourceGroupName: $(ShiraStorageAccount-rg)
#    ResourceType: 'Microsoft.Storage/storageAccounts'
#    ResourceName: 'shirastorageaccount0a'
#    AlertRules:  Set-AzContext -Subscription $(subscriptionID)


#Task 5
#Create, Upload and Copy 100 blobs from Storage account A to B
#Execute it on the windows server
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      Set-AzContext -Subscription $(subscriptionID)

        #$Server = "shiraWindowsServer2"
        #[System.String]$ScriptBlock = {Get-Process}
        #$FileName = "Create_Uplad_CopyBlobs.ps1"
        #Out-File -FilePath $FileName -InputObject $ScriptBlock -NoNewline
        #$vm = Get-AzVM -Name $Server
        #$result = Invoke-AzVMRunCommand -ResourceGroupName ShiraStorageAccount-rg -VMName shiraWindowsServer2 -CommandId RunPowerShellScript -ScriptPath .\Create_Uplad_CopyBlobs.ps1
    
      $result = Invoke-AzVMRunCommand `
       -ResourceGroupName ShiraStorageAccount-rg `
       -VMName shiraWindowsServer2 `
       -CommandId RunPowerShellScript `
       -ScriptPath .\Create_Uplad_CopyBlobs.ps1 `
       
       if ($result.value.Message -like '*error*') 
        {  
         Write-Output "Failed. An error occurred: `n $($result.value.Message)" | Out-File -Filepath C:\Users\ShiraZadok\Microsoft\OutputLog.txt -Append -Force
         throw $($result.value.Message)        
        }
        else
        {
          Write-Output "Success" | Out-File -Filepath C:\Users\ShiraZadok\Microsoft\OutputLog.txt -Append -Force
        }

        

#- task: AzureMonitorAlerts@0
#  inputs:
#    azureSubscription: $(subscriptionName)
#    ResourceGroupName: $(ShiraStorageAccount-rg)
#    ResourceType: 'Microsoft.Compute/virtualMachines'
#    ResourceName: 'ShiraWindowsServer'
#    AlertRules: 


